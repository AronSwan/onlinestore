# 安全与合规（加强版）

## 目录
- [安全架构概述](#安全架构概述)
- [网络安全与端口管理](#网络安全与端口管理)
- [速率限制与反滥用机制](#速率限制与反滥用机制)
- [隐私保护与日志安全](#隐私保护与日志安全)
- [数据来源与更新](#数据来源与更新)
- [合规与政策](#合规与政策)

## 安全架构概述

AfterShip Email Verifier 在设计上考虑了多种安全因素，包括网络安全、数据隐私和合规性要求。本文基于源码分析，聚焦于安全实现细节与生产安全建议。

## 网络安全与端口管理

### 1. 端口访问控制
- **25端口封锁**：多数ISP封锁25端口，启用SMTP检查将导致超时或拒绝
- **解决方案**：建议使用代理或改用厂商API校验（需合规评估）
- **代理配置**：支持SOCKS4/4a/5代理，绕过端口限制

### 2. 传输安全
- **SMTP加密**：支持STARTTLS加密连接
- **HTTPS传输**：Gravatar查询和域名更新使用HTTPS
- **证书验证**：验证服务器证书有效性，防止中间人攻击

网络与端口

## 速率限制与反滥用机制

### 1. SMTP验证限流
- **并发控制**：对MX主机做并发拨号与RCPT操作，若无限流会触发对端反爬/限速
- **建议策略**：
  - 域级并发上限与全局并发上限
  - 指数退避与抖动；短期失败负缓存
  - 使用worker pool控制并发数量

### 2. API验证配额管理
- **厂商API限制**：存在配额与策略限制
- **监控机制**：需监控配额消耗与失败率，设置降级路径
- **重试策略**：实现智能重试机制，避免配额浪费

## 隐私保护与日志安全

### 1. 数据隐私保护
- **不发送实际邮件**：仅进行DNS/SMTP握手，不发送真实邮件内容
- **邮箱地址保护**：避免记录完整邮箱地址，使用掩码处理

### 2. 日志安全策略
- **敏感信息过滤**：避免记录完整SMTP原始响应与代理凭证
- **最小化日志**：仅保留必要的错误语义码（如ErrFullInbox/ErrNotAllowed）与邮箱掩码/域名
- **安全配置**：代理URI（含凭证）应通过安全配置管理，不写入代码或明文日志

速率限制与反滥用

隐私与日志
- 不发送实际邮件，但进行 DNS/SMTP 握手。避免记录完整 SMTP 原始响应与代理凭证。
- 日志仅保留必要的错误语义码（如 ErrFullInbox/ErrNotAllowed）与邮箱掩码/域名。
- 代理 URI（含凭证）应通过安全配置管理，不写入代码或明文日志。

数据来源与更新
- 一次性域名清单由外部来源提供，EnableAutoUpdateDisposable() 将周期更新：
  - 更新流程可能短暂不一致（先删除后写入），在高并发场景建议外层读写锁或原子替换策略。
  - 标注来源与更新时间，避免误判影响用户体验。

合规与政策
- 厂商 API 使用须遵守服务使用条款与隐私政策；在跨地区代理与API调用时，需考虑合规（数据跨境、运营商政策）。
- 用户数据最小化与可审计：保留必要字段、生命周期管理与访问控制。