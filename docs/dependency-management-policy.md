# 依赖管理策略

## 概述
本文档定义了项目依赖管理的策略和最佳实践，确保项目安全性、稳定性和可维护性。

## 版本管理策略

### 1. 语义化版本控制
遵循 [Semantic Versioning](https://semver.org/) 规范：
- **主版本号 (MAJOR)**: 不兼容的 API 变更
- **次版本号 (MINOR)**: 向后兼容的功能性新增
- **修订号 (PATCH)**: 向后兼容的问题修正

### 2. 依赖版本范围策略

#### 生产依赖 (dependencies)
```json
{
  "exact-version": "1.2.3",           // 关键依赖精确版本
  "patch-updates": "~1.2.3",         // 允许补丁更新 (1.2.x)
  "minor-updates": "^1.2.3",         // 允许次要更新 (1.x.x)
  "range-updates": ">=1.2.3 <2.0.0"  // 自定义范围
}
```

#### 开发依赖 (devDependencies)
```json
{
  "build-tools": "^5.0.0",     // 构建工具允许次要更新
  "test-tools": "^29.0.0",     // 测试工具允许次要更新
  "linting": "^9.0.0"          // 代码检查工具允许次要更新
}
```

### 3. 关键依赖版本锁定

#### 前端关键依赖
- **vite**: 构建工具，锁定次要版本
- **playwright**: 测试框架，锁定次要版本
- **eslint**: 代码检查，锁定次要版本

#### 后端关键依赖
- **@nestjs/core**: 核心框架，锁定次要版本
- **typeorm**: 数据库 ORM，锁定次要版本
- **express**: Web 框架，锁定次要版本

## 安全策略

### 1. 漏洞检测
- **自动检测**: 使用 `npm audit` 定期检查
- **CI/CD 集成**: 在构建流程中集成安全检查
- **第三方工具**: 使用 Snyk、GitHub Security Advisories

### 2. 漏洞修复优先级

#### 高危漏洞 (Critical/High)
- **响应时间**: 24小时内
- **修复策略**: 立即更新或寻找替代方案
- **测试要求**: 完整回归测试

#### 中危漏洞 (Medium)
- **响应时间**: 1周内
- **修复策略**: 计划更新，评估影响
- **测试要求**: 相关功能测试

#### 低危漏洞 (Low)
- **响应时间**: 1个月内
- **修复策略**: 定期维护时处理
- **测试要求**: 基础功能验证

### 3. 安全更新流程
1. **检测**: 自动化安全扫描
2. **评估**: 分析漏洞影响范围
3. **测试**: 在开发环境验证修复
4. **部署**: 分阶段部署到生产环境
5. **监控**: 部署后监控系统状态

## 更新策略

### 1. 自动更新
- **补丁版本**: 自动更新（安全修复）
- **安全更新**: 立即自动更新
- **依赖锁文件**: 定期自动更新

### 2. 手动更新
- **次要版本**: 定期手动评估和更新
- **主要版本**: 计划性升级，充分测试
- **框架升级**: 专门的升级项目

### 3. 更新时机
- **安全更新**: 立即
- **补丁更新**: 每周
- **次要更新**: 每月
- **主要更新**: 每季度评估

## 依赖选择标准

### 1. 技术标准
- **活跃维护**: 最近6个月有更新
- **社区支持**: GitHub stars > 1000
- **文档质量**: 完整的文档和示例
- **测试覆盖**: 良好的测试覆盖率

### 2. 安全标准
- **无已知漏洞**: 通过安全扫描
- **维护者信誉**: 知名维护者或组织
- **代码审查**: 开源且可审查
- **许可证兼容**: 兼容项目许可证

### 3. 性能标准
- **包大小**: 合理的包大小
- **运行时性能**: 不影响应用性能
- **构建时间**: 不显著增加构建时间
- **内存使用**: 合理的内存占用

## 许可证管理

### 1. 允许的许可证
- **MIT**: 最宽松的许可证
- **Apache-2.0**: 商业友好
- **BSD-2-Clause/BSD-3-Clause**: 简单的许可证
- **ISC**: 类似 MIT 的许可证

### 2. 禁止的许可证
- **GPL**: 传染性许可证
- **AGPL**: 网络传染性许可证
- **LGPL**: 限制性许可证
- **未知许可证**: 无明确许可证的包

### 3. 许可证检查
```bash
# 安装许可证检查工具
npm install -g license-checker

# 检查许可证
license-checker --summary
license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC'
```

## 工具和自动化

### 1. 依赖管理工具
- **npm audit**: 安全漏洞检查
- **npm outdated**: 过时依赖检查
- **npm update**: 依赖更新
- **Dependabot**: 自动化依赖更新
- **Renovate**: 高级依赖管理

### 2. CI/CD 集成
```yaml
# GitHub Actions 示例
- name: 安全检查
  run: npm audit --audit-level=moderate

- name: 许可证检查
  run: license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC'

- name: 依赖检查
  run: npm outdated
```

### 3. 自动化脚本
- **安全更新脚本**: `scripts/safe-update.js`
- **依赖检查脚本**: `scripts/update-dependencies.js`
- **许可证检查脚本**: `scripts/license-check.js`

## 监控和报告

### 1. 定期报告
- **周报**: 安全漏洞状态
- **月报**: 依赖更新情况
- **季报**: 依赖健康度评估

### 2. 监控指标
- **漏洞数量**: 按严重程度分类
- **过时依赖**: 按更新类型分类
- **许可证合规**: 不合规依赖数量
- **更新频率**: 依赖更新的频率

### 3. 告警机制
- **高危漏洞**: 立即告警
- **许可证违规**: 构建失败
- **依赖过时**: 定期提醒

## 应急响应

### 1. 安全事件响应
1. **发现**: 自动检测或手动报告
2. **评估**: 快速评估影响范围
3. **隔离**: 必要时隔离受影响系统
4. **修复**: 应用安全补丁
5. **验证**: 确认修复有效性
6. **恢复**: 恢复正常服务
7. **总结**: 事后分析和改进

### 2. 回滚策略
- **版本控制**: 使用 Git 标签标记稳定版本
- **快速回滚**: 准备快速回滚脚本
- **数据备份**: 确保数据完整性
- **服务恢复**: 最小化服务中断时间

## 最佳实践

### 1. 开发实践
- **锁定文件**: 提交 package-lock.json
- **精确版本**: 关键依赖使用精确版本
- **定期更新**: 建立定期更新机制
- **测试覆盖**: 确保充分的测试覆盖

### 2. 团队协作
- **文档维护**: 保持依赖文档更新
- **知识共享**: 团队内部知识分享
- **代码审查**: 依赖变更需要代码审查
- **培训教育**: 定期安全培训

### 3. 持续改进
- **流程优化**: 定期优化依赖管理流程
- **工具升级**: 使用最新的管理工具
- **经验总结**: 总结和分享经验教训
- **标准更新**: 根据实践更新标准

---

*最后更新: 2024年*
*下次审查: 每季度*