name: ä¾èµ–å®‰å…¨æ£€æŸ¥

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è¿è¡Œ
    - cron: '0 8 * * 1'
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          backend/package-lock.json
        
    - name: å®‰è£…å‰ç«¯ä¾èµ–
      run: npm ci
      
    - name: å®‰è£…åç«¯ä¾èµ–
      run: |
        cd backend
        npm ci
        
    - name: å‰ç«¯å®‰å…¨å®¡è®¡
      run: |
        echo "=== å‰ç«¯å®‰å…¨å®¡è®¡ ==="
        npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: åç«¯å®‰å…¨å®¡è®¡
      run: |
        echo "=== åç«¯å®‰å…¨å®¡è®¡ ==="
        cd backend
        npm audit --audit-level=moderate
      continue-on-error: true
      
    - name: æ£€æŸ¥è¿‡æ—¶ä¾èµ–
      run: |
        echo "=== å‰ç«¯è¿‡æ—¶ä¾èµ– ==="
        npm outdated || true
        echo "=== åç«¯è¿‡æ—¶ä¾èµ– ==="
        cd backend
        npm outdated || true
        
    - name: è¿è¡Œè‡ªå®šä¹‰ä¾èµ–æ£€æŸ¥
      run: |
        node scripts/update-dependencies.js --verbose
        
    - name: å¯¼å‡ºå®‰å…¨å®¡è®¡ JSONï¼ˆå‰ç«¯/åç«¯ï¼‰
      if: always()
      run: |
        echo "=== å¯¼å‡ºå‰ç«¯å®¡è®¡ JSON ==="
        npm audit --json > frontend-audit.json || true
        echo "=== å¯¼å‡ºåç«¯å®¡è®¡ JSON ==="
        cd backend
        npm audit --json > backend-audit.json || true
      shell: bash

    - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Šä¸å®¡è®¡ JSON
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-report-node-${{ matrix.node-version }}
        path: |
          docs/dependency-update-report.json
          logs/dependency-update.log
          frontend-audit.json
          backend/backend-audit.json
        retention-days: 30
        
    - name: åˆ›å»º Issueï¼ˆå¦‚æœå‘ç°å®‰å…¨æ¼æ´ï¼‰
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const reportPath = path.join(process.cwd(), 'docs/dependency-update-report.json');
            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const criticalRecommendations = report.recommendations.filter(
                rec => rec.priority === 'critical'
              );
              
              if (criticalRecommendations.length > 0) {
                const issueBody = `
          ## ğŸš¨ å‘ç°å®‰å…¨æ¼æ´
          
          è‡ªåŠ¨ä¾èµ–æ£€æŸ¥å‘ç°äº†éœ€è¦ç«‹å³å¤„ç†çš„å®‰å…¨é—®é¢˜ï¼š
          
          ${criticalRecommendations.map(rec => `- ${rec.message}`).join('\n')}
          
          ### æ£€æŸ¥è¯¦æƒ…
          - **æ£€æŸ¥æ—¶é—´**: ${report.timestamp}
          - **Node.js ç‰ˆæœ¬**: ${report.nodeVersion.current}
          
          ### å‰ç«¯å®‰å…¨çŠ¶å†µ
          - **æ¼æ´æ€»æ•°**: ${report.frontend.security.totalVulnerabilities || 0}
          
          ### åç«¯å®‰å…¨çŠ¶å†µ
          - **æ¼æ´æ€»æ•°**: ${report.backend.security.totalVulnerabilities || 0}
          
          ### å»ºè®®æ“ä½œ
          1. ç«‹å³è¿è¡Œ \`npm audit fix\` ä¿®å¤è‡ªåŠ¨å¯ä¿®å¤çš„æ¼æ´
          2. æ‰‹åŠ¨æ£€æŸ¥å’Œæ›´æ–°æ— æ³•è‡ªåŠ¨ä¿®å¤çš„ä¾èµ–
          3. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶ç¡®ä¿æ›´æ–°ä¸ä¼šç ´ååŠŸèƒ½
          4. éƒ¨ç½²å‰è¿›è¡Œå®‰å…¨éªŒè¯
          
          ---
          *æ­¤ Issue ç”±è‡ªåŠ¨åŒ–ä¾èµ–æ£€æŸ¥å·¥ä½œæµåˆ›å»º*
                `;
                
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ğŸš¨ å®‰å…¨æ¼æ´è­¦æŠ¥ - ${new Date().toISOString().split('T')[0]}`,
                  body: issueBody,
                  labels: ['security', 'dependencies', 'high-priority']
                });
              }
            }
          } catch (error) {
            console.log('åˆ›å»º Issue æ—¶å‡ºé”™:', error);
          }

  license-check:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        cache: 'npm'
        
    - name: å®‰è£… license-checker
      run: npm install -g license-checker
      
    - name: æ£€æŸ¥å‰ç«¯è®¸å¯è¯
      run: |
        echo "=== å‰ç«¯è®¸å¯è¯æ£€æŸ¥ ==="
        npm ci
        license-checker --summary
        license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unlicense' || true
        
    - name: æ£€æŸ¥åç«¯è®¸å¯è¯
      run: |
        echo "=== åç«¯è®¸å¯è¯æ£€æŸ¥ ==="
        cd backend
        npm ci
        license-checker --summary
        license-checker --onlyAllow 'MIT;Apache-2.0;BSD-2-Clause;BSD-3-Clause;ISC;Unlicense' || true

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¾èµ–å®¡æŸ¥
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, Unlicense