name: Secrets and Sensitive Files Check

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  check-secrets:
    name: Check for Sensitive Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for SSH private keys
        run: |
          echo "ğŸ” Checking for SSH private keys..."
          
          # Check for common SSH key patterns
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(pem|key|ppk)$|_rsa|_dsa|_ecdsa|_ed25519|_nopass'; then
            echo "âŒ ERROR: SSH private key files detected in commit!"
            echo "The following files match private key patterns:"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(pem|key|ppk)$|_rsa|_dsa|_ecdsa|_ed25519|_nopass'
            exit 1
          fi
          
          # Check for specific project keys
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -i 'onlinestore_nopass_ed25519'; then
            echo "âŒ ERROR: Project SSH key file detected!"
            exit 1
          fi
          
          echo "âœ… No SSH private keys found in changed files"

      - name: Check for .env files with secrets
        run: |
          echo "ğŸ” Checking for .env files..."
          
          # Check for .env files (except .env.example)
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^\.env$|\.env\.local$|\.env\.production$' | grep -v '.env.example'; then
            echo "âš ï¸  WARNING: .env files detected in commit!"
            echo "These files may contain sensitive data:"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^\.env$|\.env\.local$|\.env\.production$' | grep -v '.env.example'
            echo "Please ensure sensitive data is removed or use .env.example instead"
            exit 1
          fi
          
          echo "âœ… No .env files with secrets found"

      - name: Check for certificates and tokens
        run: |
          echo "ğŸ” Checking for certificates and token files..."
          
          # Check for certificate files
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(crt|cer|p12|pfx)$'; then
            echo "âŒ ERROR: Certificate files detected in commit!"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(crt|cer|p12|pfx)$'
            exit 1
          fi
          
          # Check for token files
          if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(token|secret)$|-token\.txt$|-secret\.txt$'; then
            echo "âŒ ERROR: Token/secret files detected in commit!"
            git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(token|secret)$|-token\.txt$|-secret\.txt$'
            exit 1
          fi
          
          echo "âœ… No certificates or token files found"

      - name: Scan file contents for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: GitGuardian scan
        uses: GitGuardian/ggshield-action@v1
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}
        continue-on-error: true

      - name: Final security summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Security Check Passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… No SSH private keys found"
          echo "âœ… No sensitive .env files found"
          echo "âœ… No certificates or tokens found"
          echo "âœ… No secrets detected in file contents"
          echo ""
          echo "Your commit is safe to merge! ğŸ‰"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Security check failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Security Check FAILED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âš ï¸  Sensitive files or secrets were detected in your commit."
          echo ""
          echo "ğŸ”§ What to do:"
          echo "   1. Remove the sensitive files from your commit"
          echo "   2. Update your .gitignore to prevent future commits"
          echo "   3. Rotate any exposed credentials immediately"
          echo "   4. Review the error messages above for details"
          echo ""
          echo "ğŸ“š Resources:"
          echo "   - How to remove files from Git history:"
          echo "     https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/removing-sensitive-data-from-a-repository"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          exit 1
