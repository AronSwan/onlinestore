# Nominatim 使用策略和最佳实践

## 概述

基于对 OSM Nominatim 使用政策的深入研究，本文档制定了符合规范的地址处理策略。

## OSM Nominatim 使用限制

### 严格限制
- **速率限制**：每秒最多 1 个请求
- **禁止批量地理编码**：不允许大量数据的批量处理
- **禁止自动完成搜索**：不支持实时搜索建议
- **禁止系统性查询**：不允许网格式反向查询

### 技术要求
- 必须提供有效的 HTTP Referer 或 User-Agent
- 必须缓存结果，避免重复查询
- 需要适当的归属声明
- 商业应用建议设置代理服务器

## 我们的应对策略

### 1. 多层缓存架构

```
用户请求 → Redis缓存 → 数据库缓存 → Nominatim API → 结果缓存
```

### 2. 智能降级策略

1. **优先级顺序**：
   - 本地缓存（Redis）
   - 数据库历史记录
   - 地址格式化库（离线）
   - Nominatim API（最后选择）

2. **批量处理策略**：
   - 将批量请求拆分为单个请求
   - 使用队列系统控制请求频率
   - 实现延迟处理机制

### 3. 缓存策略

#### Redis 缓存
- **地理编码缓存**：地址 → 坐标，TTL: 30天
- **反向地理编码缓存**：坐标 → 地址，TTL: 7天
- **失败缓存**：失败的查询，TTL: 1小时

#### 数据库缓存
- 永久存储成功的地理编码结果
- 建立地址标准化索引
- 支持模糊匹配和相似地址查找

### 4. 请求优化

#### 预处理
- 地址标准化和清理
- 重复地址检测
- 无效地址过滤

#### 后处理
- 结果验证和质量评分
- 多个结果的智能选择
- 置信度评估

## 实施计划

### 阶段 1：缓存层实现
- [ ] Redis 缓存服务
- [ ] 数据库缓存表
- [ ] 缓存策略配置

### 阶段 2：队列系统
- [ ] 地理编码任务队列
- [ ] 速率限制控制器
- [ ] 批量处理器

### 阶段 3：降级机制
- [ ] 离线地址验证
- [ ] 备用地理编码服务
- [ ] 优雅降级逻辑

### 阶段 4：监控和优化
- [ ] API 使用量监控
- [ ] 缓存命中率统计
- [ ] 性能优化

## 配置建议

### 生产环境
```yaml
nominatim:
  # 使用自托管实例或商业代理
  baseUrl: "https://your-nominatim-proxy.com"
  rateLimit: 10 # 每秒请求数
  timeout: 5000
  
cache:
  redis:
    ttl:
      geocode: 2592000 # 30天
      reverse: 604800  # 7天
      failed: 3600     # 1小时
      
queue:
  geocoding:
    concurrency: 1
    delay: 1000 # 1秒延迟
```

### 开发环境
```yaml
nominatim:
  baseUrl: "https://nominatim.openstreetmap.org"
  rateLimit: 1 # 严格遵守公共API限制
  timeout: 10000
```

## 监控指标

### 关键指标
- Nominatim API 调用次数/天
- 缓存命中率
- 平均响应时间
- 失败率

### 告警阈值
- API 调用超过 1000次/天
- 缓存命中率低于 80%
- 失败率超过 5%

## 合规性检查清单

- [ ] 实现了 1秒/请求的速率限制
- [ ] 设置了正确的 User-Agent
- [ ] 实现了结果缓存
- [ ] 避免了批量地理编码
- [ ] 添加了 OSM 归属声明
- [ ] 实现了优雅降级
- [ ] 设置了使用量监控

## 风险评估

### 高风险
- 超出 OSM 使用限制可能导致 IP 被封
- 依赖单一服务可能影响系统可用性

### 缓解措施
- 实施严格的速率限制
- 建立多层缓存机制
- 准备备用地理编码服务
- 实现离线地址处理能力

## 总结

通过实施这个策略，我们可以：
1. 完全符合 OSM Nominatim 使用政策
2. 最小化对外部 API 的依赖
3. 提供稳定可靠的地址处理服务
4. 为未来扩展预留空间

这个策略平衡了功能需求、合规要求和系统稳定性，确保我们能够长期可持续地使用 Nominatim 服务。