# 用途：Jaeger链路追踪服务Kubernetes部署配置
# 依赖文件：无
# 作者：后端开发团队
# 时间：2025-09-29 23:20:00

---
# Jaeger Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jaeger
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      labels:
        app: jaeger
    spec:
      containers:
      - name: jaeger
        image: jaegertracing/all-in-one:latest
        ports:
        - containerPort: 16686  # UI端口
        - containerPort: 14268  # HTTP收集端口
        - containerPort: 14250  # gRPC收集端口
        - containerPort: 6831   # UDP compact thrift端口
        - containerPort: 6832   # UDP binary thrift端口
        env:
        - name: COLLECTOR_ZIPKIN_HOST_PORT
          value: ":9411"
        - name: SPAN_STORAGE_TYPE
          value: "memory"
        resources:
          limits:
            memory: "512Mi"
            cpu: "500m"
          requests:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /
            port: 16686
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 16686
          initialDelaySeconds: 5
          periodSeconds: 5

---
# Jaeger Service
apiVersion: v1
kind: Service
metadata:
  name: jaeger-service
  namespace: default
spec:
  selector:
    app: jaeger
  ports:
    - name: ui
      protocol: TCP
      port: 16686
      targetPort: 16686
    - name: collector-http
      protocol: TCP
      port: 14268
      targetPort: 14268
    - name: collector-grpc
      protocol: TCP
      port: 14250
      targetPort: 14250
    - name: collector-compact
      protocol: UDP
      port: 6831
      targetPort: 6831
    - name: collector-binary
      protocol: UDP
      port: 6832
      targetPort: 6832
    - name: zipkin
      protocol: TCP
      port: 9411
      targetPort: 9411
  type: ClusterIP

---
# Jaeger Ingress
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jaeger-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  rules:
  - host: jaeger.caddy-shopping.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: jaeger-service
            port:
              number: 16686

---
# Jaeger ServiceMonitor (用于Prometheus监控Jaeger自身)
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: jaeger-monitor
  namespace: default
  labels:
    app: jaeger
spec:
  selector:
    matchLabels:
      app: jaeger
  endpoints:
  - port: ui
    interval: 30s
    path: /metrics
