# æ–‡æ¡£è´¨é‡é—¨ç¦é…ç½®
# ç”¨äº GitHub Actions æˆ–å…¶ä»– CI/CD ç³»ç»Ÿ

name: Documentation Quality Gate

on:
  push:
    paths:
      - 'backend/docs/**'
      - 'backend/src/**/*.ts'
  pull_request:
    paths:
      - 'backend/docs/**'
      - 'backend/src/**/*.ts'

jobs:
  docs-quality-check:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup PowerShell
      shell: pwsh
      run: |
        # å®‰è£…å¿…è¦çš„ PowerShell æ¨¡å—
        Install-Module -Name powershell-yaml -Force -Scope CurrentUser
        
    - name: Markdown Lint Check
      shell: pwsh
      run: |
        cd backend/docs
        # æ£€æŸ¥ Markdown è¯­æ³•
        npx markdownlint-cli2 "**/*.md" --config quality/markdownlint.json
        
    - name: Link Checker
      shell: pwsh
      run: |
        cd backend/docs
        # æ£€æŸ¥æ–‡æ¡£ä¸­çš„æ­»é“¾
        npx markdown-link-check **/*.md --config quality/link-check-config.json
        
    - name: API Documentation Sync Check
      shell: pwsh
      run: |
        cd backend/docs
        # è¿è¡Œ API æ–‡æ¡£åŒæ­¥æ£€æŸ¥
        ./automation/api-docs-sync.ps1 -OpenApiPath "./openapi.json" -ApiDocsPath "./API_DOCUMENTATION.md"
        
    - name: Documentation Coverage Check
      shell: pwsh
      run: |
        cd backend/docs
        # æ£€æŸ¥æ–‡æ¡£è¦†ç›–ç‡
        ./automation/docs-coverage-check.ps1
        
    - name: Frontmatter Validation
      shell: pwsh
      run: |
        cd backend/docs
        # éªŒè¯ frontmatter æ ¼å¼
        ./automation/frontmatter-validator.ps1
        
    - name: Generate Quality Report
      shell: pwsh
      run: |
        cd backend/docs
        # ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        ./automation/generate-quality-report.ps1
        
    - name: Upload Quality Reports
      uses: actions/upload-artifact@v4
      with:
        name: docs-quality-reports
        path: backend/docs/quality/
        
    - name: Comment PR with Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = 'backend/docs/quality/api-sync-report.json';
          
          if (fs.existsSync(path)) {
            const report = JSON.parse(fs.readFileSync(path, 'utf8'));
            const comment = `
            ## ğŸ“Š æ–‡æ¡£è´¨é‡æ£€æŸ¥ç»“æœ
            
            - **API æ–‡æ¡£è¦†ç›–ç‡**: ${report.coverage}%
            - **ç¼ºå¤±ç«¯ç‚¹**: ${report.missingInDocs}
            - **æ£€æŸ¥æ—¶é—´**: ${report.timestamp}
            
            ${report.coverage >= 95 ? 'âœ… æ–‡æ¡£è´¨é‡è‰¯å¥½' : 'âš ï¸ éœ€è¦æ”¹è¿›æ–‡æ¡£'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }