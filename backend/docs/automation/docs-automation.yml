# æ–‡æ¡£è‡ªåŠ¨åŒ– GitHub Actions å·¥ä½œæµ
name: ğŸ“š Documentation Automation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'backend/src/**'
      - 'backend/docs/**'
      - 'backend/package.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/src/**'
      - 'backend/docs/**'
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ£€æŸ¥å’Œæ›´æ–°
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ‰€æœ‰æ–‡æ¡£'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  DOCS_DIR: 'backend/docs'
  GENERATED_DIR: 'backend/docs/generated'

jobs:
  # æ–‡æ¡£è´¨é‡æ£€æŸ¥
  docs-quality-check:
    name: ğŸ“‹ æ–‡æ¡£è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      docs-changed: ${{ steps.changes.outputs.docs }}
      code-changed: ${{ steps.changes.outputs.code }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ£€æµ‹å˜æ›´æ–‡ä»¶
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            docs:
              - 'backend/docs/**'
            code:
              - 'backend/src/**'
              - 'backend/package.json'

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: |
          npm ci
          npm install -g markdownlint-cli markdown-link-check

      - name: ğŸ“ Markdown æ ¼å¼æ£€æŸ¥
        working-directory: backend
        run: |
          echo "ğŸ” æ£€æŸ¥ Markdown æ–‡ä»¶æ ¼å¼..."
          markdownlint docs/**/*.md --config docs/quality/markdownlint.json || true

      - name: ğŸ”— é“¾æ¥æœ‰æ•ˆæ€§æ£€æŸ¥
        working-directory: backend
        run: |
          echo "ğŸ”— æ£€æŸ¥æ–‡æ¡£é“¾æ¥æœ‰æ•ˆæ€§..."
          find docs -name "*.md" -exec markdown-link-check {} \; || true

      - name: ğŸ“Š æ–‡æ¡£è¦†ç›–ç‡æ£€æŸ¥
        working-directory: backend
        run: |
          echo "ğŸ“Š æ£€æŸ¥æ–‡æ¡£è¦†ç›–ç‡..."
          npm run docs:coverage-check || true

      - name: ğŸ” æ‹¼å†™æ£€æŸ¥
        working-directory: backend
        run: |
          echo "ğŸ”¤ æ£€æŸ¥æ–‡æ¡£æ‹¼å†™..."
          npx cspell "docs/**/*.md" --config docs/quality/cspell.json || true

  # API æ–‡æ¡£ç”Ÿæˆ
  generate-api-docs:
    name: ğŸ”Œ ç”Ÿæˆ API æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: docs-quality-check
    if: needs.docs-quality-check.outputs.code-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: npm ci

      - name: ğŸ”Œ ç”Ÿæˆ OpenAPI è§„èŒƒæ–‡ä»¶
        working-directory: backend
        run: |
          echo "ğŸ”Œ ç”Ÿæˆ OpenAPI æ–‡æ¡£..."
          npm run build
          npm run docs:api:generate
          
          # ç¡®ä¿ç”Ÿæˆçš„æ–‡ä»¶å­˜åœ¨
          if [ ! -f "docs/openapi.json" ]; then
            echo "âš ï¸ OpenAPI æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“– ç”Ÿæˆ TypeDoc æ–‡æ¡£
        working-directory: backend
        run: |
          echo "ğŸ“– ç”Ÿæˆä»£ç æ–‡æ¡£..."
          mkdir -p ${{ env.GENERATED_DIR }}/code-docs
          npx typedoc --out ${{ env.GENERATED_DIR }}/code-docs src --theme minimal

      - name: ğŸ“Š ç”Ÿæˆ API ä½¿ç”¨ç¤ºä¾‹
        working-directory: backend
        run: |
          echo "ğŸ“Š ç”Ÿæˆ API ä½¿ç”¨ç¤ºä¾‹..."
          npm run docs:api:examples

      - name: ğŸ’¾ ä¸Šä¼  API æ–‡æ¡£
        uses: actions/upload-artifact@v4
        with:
          name: api-docs
          path: |
            backend/docs/openapi.json
            backend/docs/generated/code-docs/
            backend/docs/api/examples/
          retention-days: 30

  # æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆ
  generate-coverage-report:
    name: ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: docs-quality-check
    if: needs.docs-quality-check.outputs.code-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: npm ci

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        working-directory: backend
        run: |
          echo "ğŸ§ª è¿è¡Œæµ‹è¯•å¥—ä»¶..."
          npm run test:cov
          
          # ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
          mkdir -p ${{ env.GENERATED_DIR }}/test-coverage
          npx nyc report --reporter=html --report-dir=${{ env.GENERATED_DIR }}/test-coverage

      - name: ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡å¾½ç« 
        working-directory: backend
        run: |
          echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡å¾½ç« ..."
          npm run docs:coverage-badge

      - name: ğŸ“ˆ æ›´æ–°è¦†ç›–ç‡æŠ¥å‘Šæ–‡æ¡£
        working-directory: backend
        run: |
          echo "ğŸ“ˆ æ›´æ–°è¦†ç›–ç‡æŠ¥å‘Š..."
          npm run docs:coverage-update

      - name: ğŸ’¾ ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            backend/docs/generated/test-coverage/
            backend/docs/quality/TEST_COVERAGE_REPORT.md
          retention-days: 30

  # å®‰å…¨æ‰«ææŠ¥å‘Šç”Ÿæˆ
  generate-security-report:
    name: ğŸ›¡ï¸ ç”Ÿæˆå®‰å…¨æ‰«ææŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: docs-quality-check
    if: needs.docs-quality-check.outputs.code-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: npm ci

      - name: ğŸ” ä¾èµ–å®‰å…¨æ‰«æ
        working-directory: backend
        run: |
          echo "ğŸ” æ‰§è¡Œå®‰å…¨æ‰«æ..."
          npm audit --audit-level=moderate --json > audit-report.json || true
          
          # ç”Ÿæˆå®‰å…¨æŠ¥å‘Š
          npm run docs:security:generate

      - name: ğŸ›¡ï¸ ç”Ÿæˆå®‰å…¨ä»ªè¡¨æ¿
        working-directory: backend
        run: |
          echo "ğŸ›¡ï¸ ç”Ÿæˆå®‰å…¨ä»ªè¡¨æ¿..."
          npm run docs:security:dashboard

      - name: ğŸ“Š æ›´æ–°å®‰å…¨æ–‡æ¡£
        working-directory: backend
        run: |
          echo "ğŸ“Š æ›´æ–°å®‰å…¨ç›¸å…³æ–‡æ¡£..."
          npm run docs:security:update

      - name: ğŸ’¾ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: |
            backend/docs/security-dashboard.html
            backend/docs/generated/security-reports/
          retention-days: 30

  # æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š
  generate-performance-report:
    name: âš¡ ç”Ÿæˆæ€§èƒ½åŸºå‡†æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: docs-quality-check
    if: needs.docs-quality-check.outputs.code-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: npm ci

      - name: ğŸš€ å¯åŠ¨æµ‹è¯•æœåŠ¡
        working-directory: backend
        run: |
          echo "ğŸš€ å¯åŠ¨åº”ç”¨è¿›è¡Œæ€§èƒ½æµ‹è¯•..."
          npm run build
          npm run start:prod &
          sleep 30  # ç­‰å¾…åº”ç”¨å¯åŠ¨

      - name: âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        working-directory: backend
        run: |
          echo "âš¡ æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
          npm run test:performance
          
          # ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
          npm run docs:performance:generate

      - name: ğŸ“Š ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿å›¾
        working-directory: backend
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ€§èƒ½è¶‹åŠ¿åˆ†æ..."
          npm run docs:performance:trends

      - name: ğŸ’¾ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: |
            backend/docs/generated/performance-reports/
            backend/docs/MONITORING_PERFORMANCE_REPORT.md
          retention-days: 30

  # æ–‡æ¡£ç½‘ç«™æ„å»ºå’Œéƒ¨ç½²
  build-and-deploy-docs:
    name: ğŸŒ æ„å»ºå¹¶éƒ¨ç½²æ–‡æ¡£ç½‘ç«™
    runs-on: ubuntu-latest
    needs: [docs-quality-check, generate-api-docs, generate-coverage-report, generate-security-report, generate-performance-report]
    if: always() && (needs.docs-quality-check.result == 'success')
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: npm ci

      - name: ğŸ“¥ ä¸‹è½½ç”Ÿæˆçš„æ–‡æ¡£
        uses: actions/download-artifact@v4
        with:
          path: backend/docs/generated/
          merge-multiple: true

      - name: ğŸ”§ é…ç½®æ–‡æ¡£ç½‘ç«™
        working-directory: backend
        run: |
          echo "ğŸ”§ é…ç½® Docusaurus..."
          npm run docs:site:configure

      - name: ğŸ—ï¸ æ„å»ºæ–‡æ¡£ç½‘ç«™
        working-directory: backend
        run: |
          echo "ğŸ—ï¸ æ„å»ºé™æ€æ–‡æ¡£ç½‘ç«™..."
          npm run docs:site:build

      - name: ğŸ“Š ç”Ÿæˆç½‘ç«™åœ°å›¾
        working-directory: backend
        run: |
          echo "ğŸ“Š ç”Ÿæˆç½‘ç«™åœ°å›¾å’Œæœç´¢ç´¢å¼•..."
          npm run docs:site:sitemap

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: backend/docs/build
          cname: docs.caddy-shopping.com

      - name: ğŸ“± éƒ¨ç½²åˆ° Netlify
        if: github.ref == 'refs/heads/main'
        uses: nwtgck/actions-netlify@v2.0
        with:
          publish-dir: backend/docs/build
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

  # æ–‡æ¡£è´¨é‡æŠ¥å‘Š
  generate-quality-report:
    name: ğŸ“‹ ç”Ÿæˆæ–‡æ¡£è´¨é‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [build-and-deploy-docs]
    if: always()
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        working-directory: backend
        run: npm ci

      - name: ğŸ“Š ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        working-directory: backend
        run: |
          echo "ğŸ“Š ç”Ÿæˆç»¼åˆè´¨é‡æŠ¥å‘Š..."
          npm run docs:quality:report

      - name: ğŸ“ˆ æ›´æ–°è´¨é‡æŒ‡æ ‡
        working-directory: backend
        run: |
          echo "ğŸ“ˆ æ›´æ–°è´¨é‡æŒ‡æ ‡..."
          npm run docs:quality:metrics

      - name: ğŸ”„ åè°ƒæ€§æ£€æŸ¥
        working-directory: backend
        run: |
          echo "ğŸ”„ æ‰§è¡Œæ–‡æ¡£åè°ƒæ€§æ£€æŸ¥..."
          npm run docs:coordination-check

      - name: ğŸ“ ç”Ÿæˆæ”¹è¿›å»ºè®®
        working-directory: backend
        run: |
          echo "ğŸ“ ç”Ÿæˆæ”¹è¿›å»ºè®®..."
          npm run docs:improvement:suggestions

      - name: ğŸ’¾ ä¸Šä¼ è´¨é‡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            backend/docs/quality/
            backend/docs/improvement/
          retention-days: 90

  # é€šçŸ¥å’Œæ€»ç»“
  notify-completion:
    name: ğŸ“¢ é€šçŸ¥å®ŒæˆçŠ¶æ€
    runs-on: ubuntu-latest
    needs: [generate-quality-report]
    if: always()
    
    steps:
      - name: ğŸ“Š æ”¶é›†æ‰§è¡Œç»“æœ
        run: |
          echo "ğŸ“Š æ–‡æ¡£è‡ªåŠ¨åŒ–æ‰§è¡Œç»“æœ:"
          echo "- è´¨é‡æ£€æŸ¥: ${{ needs.docs-quality-check.result }}"
          echo "- APIæ–‡æ¡£ç”Ÿæˆ: ${{ needs.generate-api-docs.result }}"
          echo "- è¦†ç›–ç‡æŠ¥å‘Š: ${{ needs.generate-coverage-report.result }}"
          echo "- å®‰å…¨æ‰«æ: ${{ needs.generate-security-report.result }}"
          echo "- æ€§èƒ½æµ‹è¯•: ${{ needs.generate-performance-report.result }}"
          echo "- æ–‡æ¡£éƒ¨ç½²: ${{ needs.build-and-deploy-docs.result }}"
          echo "- è´¨é‡æŠ¥å‘Š: ${{ needs.generate-quality-report.result }}"

      - name: ğŸ“§ å‘é€é‚®ä»¶é€šçŸ¥
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸ“š æ–‡æ¡£è‡ªåŠ¨åŒ–æ‰§è¡Œå¤±è´¥ - ${{ github.repository }}"
          body: |
            æ–‡æ¡£è‡ªåŠ¨åŒ–å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼
            
            åˆ†æ”¯: ${{ github.ref }}
            æäº¤: ${{ github.sha }}
            æ‰§è¡Œæ—¶é—´: ${{ github.run_id }}
            
            è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚
          to: devops@caddy-shopping.com

      - name: ğŸ’¬ Slack é€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#backend-docs'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          username: 'GitHub Actions'
          icon_emoji: ':books:'
          text: |
            ğŸ“š æ–‡æ¡£è‡ªåŠ¨åŒ–å®Œæˆ - ${{ job.status }}
            
            ğŸ”— æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            ğŸ“– æ–‡æ¡£ç½‘ç«™: https://docs.caddy-shopping.com