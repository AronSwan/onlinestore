# Test Monitor 安全功能测试 Dockerfile

FROM node:22-alpine AS test-monitor

# 安装必要的系统依赖
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    openssl \
    curl \
    bash

# 设置工作目录
WORKDIR /app

# 创建非root用户用于测试
RUN addgroup -g 1001 -S testmonitor && \
    adduser -S testuser -u 1001 -G testmonitor

# 复制package.json并安装依赖
COPY package*.json ./
RUN npm ci

# 复制Test Monitor相关文件
COPY scripts/ ./scripts/
COPY test/ ./test/
RUN mkdir -p reports && chown -R testuser:testmonitor reports

# 设置环境变量
ENV NODE_ENV=test
ENV TEST_MONITOR_USER=testuser
ENV TEST_MONITOR_GROUP=testmonitor

# 切换到非root用户
USER testuser

# 设置入口点
ENTRYPOINT ["node", "scripts/test-security-features.cjs"]