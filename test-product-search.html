<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品搜索管理器测试页面</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-container {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.success {
            background-color: #d4edda;
            color: #155724;
        }
        .test-result.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .test-result.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .search-test {
            margin-top: 20px;
        }
        .search-input {
            padding: 10px;
            width: 300px;
            margin-right: 10px;
        }
        .search-button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .search-results {
            margin-top: 20px;
        }
        pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>产品搜索管理器测试页面</h1>
    
    <div class="test-container">
        <h2>1. 初始化测试</h2>
        <div id="init-result" class="test-result">初始化中...</div>
    </div>
    
    <div class="test-container">
        <h2>2. 方法测试</h2>
        <div id="methods-result" class="test-result">测试中...</div>
    </div>
    
    <div class="test-container">
        <h2>3. 搜索功能测试</h2>
        <div class="search-test">
            <input type="text" id="search-input" class="search-input" placeholder="输入搜索关键词..." value="手机">
            <button id="search-button" class="search-button">搜索</button>
        </div>
        <div id="search-results" class="search-results">
            <pre>等待搜索结果...</pre>
        </div>
    </div>

    <!-- 模拟产品数据 -->
    <script>
        window.mockProducts = [
            {
                id: '1',
                name: '智能手机',
                price: 2999,
                originalPrice: 3499,
                category: 'electronics',
                color: 'black',
                brand: 'BrandA',
                rating: 4.5,
                reviewCount: 128,
                image: 'https://via.placeholder.com/300x200?text=Smartphone',
                description: '高性能智能手机，配备先进的处理器和摄像头系统。',
                keywords: ['手机', '智能', '通讯', '电子产品'],
                inStock: true,
                discount: 14
            },
            {
                id: '2',
                name: '笔记本电脑',
                price: 5999,
                originalPrice: 6999,
                category: 'electronics',
                color: 'silver',
                brand: 'BrandB',
                rating: 4.7,
                reviewCount: 256,
                image: 'https://via.placeholder.com/300x200?text=Laptop',
                description: '轻薄便携的笔记本电脑，适合办公和学习使用。',
                keywords: ['电脑', '笔记本', '办公', '电子产品'],
                inStock: true,
                discount: 14
            },
            {
                id: '3',
                name: '休闲T恤',
                price: 99,
                originalPrice: 129,
                category: 'clothing',
                color: 'white',
                brand: 'BrandC',
                rating: 4.2,
                reviewCount: 64,
                image: 'https://via.placeholder.com/300x200?text=T-Shirt',
                description: '舒适的纯棉T恤，适合日常休闲穿着。',
                keywords: ['T恤', '服装', '休闲', '纯棉'],
                inStock: true,
                discount: 23
            },
            {
                id: '4',
                name: '牛仔裤',
                price: 199,
                originalPrice: 249,
                category: 'clothing',
                color: 'blue',
                brand: 'BrandA',
                rating: 4.3,
                reviewCount: 96,
                image: 'https://via.placeholder.com/300x200?text=Jeans',
                description: '经典款牛仔裤，百搭时尚，适合各种场合。',
                keywords: ['牛仔裤', '服装', '休闲', '百搭'],
                inStock: true,
                discount: 20
            },
            {
                id: '5',
                name: '咖啡机',
                price: 899,
                originalPrice: 1099,
                category: 'home',
                color: 'black',
                brand: 'BrandB',
                rating: 4.6,
                reviewCount: 128,
                image: 'https://via.placeholder.com/300x200?text=Coffee+Maker',
                description: '全自动咖啡机，一键制作多种咖啡饮品。',
                keywords: ['咖啡机', '家电', '厨房', '咖啡'],
                inStock: true,
                discount: 18
            },
            {
                id: '6',
                name: '台灯',
                price: 149,
                originalPrice: 199,
                category: 'home',
                color: 'white',
                brand: 'BrandC',
                rating: 4.1,
                reviewCount: 42,
                image: 'https://via.placeholder.com/300x200?text=Desk+Lamp',
                description: 'LED护眼台灯，多档调光，适合阅读和工作。',
                keywords: ['台灯', '灯具', 'LED', '护眼'],
                inStock: true,
                discount: 25
            }
        ];
    </script>
    
    <!-- 导入产品搜索管理器 -->
    <script type="module">
        import { ProductSearchManager, defaultProductSearchManager } from './js/product-search/index.js';
        
        // 1. 初始化测试
        async function runInitTest() {
            const resultElement = document.getElementById('init-result');
            
            try {
                console.log('开始初始化测试...');
                
                // 检查ProductSearchManager类是否存在
                if (typeof ProductSearchManager !== 'function') {
                    throw new Error('ProductSearchManager类不存在');
                }
                
                // 检查defaultProductSearchManager实例是否存在
                if (!defaultProductSearchManager) {
                    throw new Error('defaultProductSearchManager实例不存在');
                }
                
                // 创建简单的容器
                const containers = {
                    products: document.createElement('div'),
                    searchInput: document.getElementById('search-input')
                };
                
                // 设置容器
                if (typeof defaultProductSearchManager.setContainers === 'function') {
                    defaultProductSearchManager.setContainers(containers);
                } else {
                    defaultProductSearchManager.containers = containers;
                }
                
                // 设置事件回调
                const callbacks = {
                    onInitComplete: function() {
                        console.log('初始化完成回调被触发');
                    },
                    onError: function(error) {
                        console.error('初始化错误:', error);
                    }
                };
                
                if (typeof defaultProductSearchManager.setEventCallbacks === 'function') {
                    defaultProductSearchManager.setEventCallbacks(callbacks);
                } else {
                    defaultProductSearchManager.eventCallbacks = callbacks;
                }
                
                // 初始化
                await defaultProductSearchManager.init();
                
                if (defaultProductSearchManager.state && defaultProductSearchManager.state.initialized) {
                    resultElement.className = 'test-result success';
                    resultElement.innerHTML = '✓ 产品搜索管理器初始化成功';
                } else {
                    resultElement.className = 'test-result warning';
                    resultElement.innerHTML = '⚠️ 产品搜索管理器初始化但状态不正常';
                }
            } catch (error) {
                resultElement.className = 'test-result error';
                resultElement.innerHTML = `✗ 初始化失败: ${error.message}`;
                console.error('初始化测试失败:', error);
            }
        }
        
        // 2. 方法测试
        function runMethodsTest() {
            const resultElement = document.getElementById('methods-result');
            
            try {
                console.log('开始方法测试...');
                
                const requiredMethods = [
                    'init', 
                    'setDependencies', 
                    'setContainers', 
                    'setEventCallbacks', 
                    'performSearch'
                ];
                
                const missingMethods = [];
                const availableMethods = [];
                
                requiredMethods.forEach(method => {
                    if (typeof defaultProductSearchManager[method] === 'function') {
                        availableMethods.push(method);
                    } else {
                        missingMethods.push(method);
                    }
                });
                
                if (missingMethods.length === 0) {
                    resultElement.className = 'test-result success';
                    resultElement.innerHTML = `✓ 所有关键方法都存在: ${availableMethods.join(', ')}`;
                } else {
                    resultElement.className = 'test-result warning';
                    resultElement.innerHTML = `⚠️ 缺少以下方法: ${missingMethods.join(', ')}<br>可用方法: ${availableMethods.join(', ')}`;
                }
            } catch (error) {
                resultElement.className = 'test-result error';
                resultElement.innerHTML = `✗ 方法测试失败: ${error.message}`;
                console.error('方法测试失败:', error);
            }
        }
        
        // 3. 搜索测试
        async function runSearch(query) {
            const resultsElement = document.getElementById('search-results');
            
            try {
                console.log(`开始搜索测试: ${query}`);
                resultsElement.innerHTML = `<pre>搜索中: ${query}...</pre>`;
                
                let searchResult;
                
                // 尝试直接使用搜索核心
                if (defaultProductSearchManager.searchCore && 
                    typeof defaultProductSearchManager.searchCore.performSearch === 'function') {
                    searchResult = await defaultProductSearchManager.searchCore.performSearch(query);
                } 
                // 或者使用performSearch方法
                else if (typeof defaultProductSearchManager.performSearch === 'function') {
                    searchResult = await defaultProductSearchManager.performSearch(query);
                }
                
                if (searchResult && searchResult.success) {
                    resultsElement.innerHTML = `
                        <pre>搜索成功!
关键词: ${query}
结果数量: ${searchResult.results.length}
结果详情: 
${JSON.stringify(searchResult.results, null, 2)}
</pre>
                    `;
                } else {
                    resultsElement.innerHTML = `<pre>⚠️ 搜索结果为空或格式不正确
返回值: ${JSON.stringify(searchResult, null, 2)}</pre>`;
                }
            } catch (error) {
                resultsElement.innerHTML = `<pre>✗ 搜索失败: ${error.message}</pre>`;
                console.error('搜索测试失败:', error);
            }
        }
        
        // 运行测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM加载完成，开始测试...');
            
            // 运行初始化测试
            runInitTest();
            
            // 运行方法测试
            runMethodsTest();
            
            // 添加搜索按钮事件
            document.getElementById('search-button').addEventListener('click', function() {
                const query = document.getElementById('search-input').value.trim();
                if (query) {
                    runSearch(query);
                } else {
                    alert('请输入搜索关键词');
                }
            });
            
            // 回车键搜索
            document.getElementById('search-input').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    const query = this.value.trim();
                    if (query) {
                        runSearch(query);
                    }
                }
            });
        });
    </script>
</body>
</html>